!function(e,t){var n=window,a=n.location,i=document.createElement("audio");i.id="sound-audio",i.setAttribute("src","images/sound.mp3"),i.setAttribute("loop",!0);var s={shuffle:function(e,t){if(!Array.isArray(e))throw new Error("shuffle expect an array as parameter.");t=t||{};var n,a,i=e,s=e.length,o=t.rng||Math.random;for(!0===t.copy&&(i=e.slice());s;)n=Math.floor(o()*s),s-=1,a=i[s],i[s]=i[n],i[n]=a;return i},query:function(e,t){if(e&&-1!=e.indexOf("?")){var n=e.substring(e.indexOf("?")+1),a={};if(n)for(var i=0,s=n.split("&"),o=s.length;i<o;i++){var r=s[i].split("=");a[r[0]]=decodeURIComponent(r[1])}return t&&a[t]?a[t]:a}}},o={warning:!1,verify:!1,subscribe:!1,binded:!1,_API:"",sound:null,started:!0,overend:!1,parameter:{},params:{openId:"ouCbltwItY_iheNPsj0GZnBk3lAs",token:"0c5b398bec01aad1759eee0d999b00a1"},config:{URI:"http://idcwxtest.dafysz.cn/",API:"wechat-web/",APPID:"wx875c67a4fc574d93"},elements:{tray:e(".tray-image")},buttons:{go:e("#lottery-go")},initialize:function(){var e=this,t=e.config;e._API=e.config.URI+e.config.API,e.parameter=s.query(a.search)||{},e.parameter.code&&sessionStorage.setItem("code",e.parameter.code),e.getUserInfo(function(n){var a=n.code,i=n.status,s=n.data||null;if(1==a&&"success"==i){if(void 0!==s.subscribe&&(e.subscribe=!!parseInt(s.subscribe,10)),s.binded&&(e.binded=!!parseInt(s.binded,10)),s.customer){var o=s.customer.openid,r=s.customer.token;e.params.openId=o,e.params.token=r,sessionStorage.setItem("openId",o),sessionStorage.setItem("token",r)}else{var o=sessionStorage.getItem("openId"),r=sessionStorage.getItem("token");e.params.openId=o,e.params.token=r}if(s.config){var c=s.config;wx.config({debug:c.debug||!1,appId:c.appId,timestamp:c.timestamp,nonceStr:c.nonceStr,signature:c.signature,jsApiList:["onMenuShareTimeline","onMenuShareAppMessage","closeWindow"]});var l="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+t.APPID+"&redirect_uri="+t.URI+"activity/zodiac&response_type=code&scope=snsapi_base&state=1#wechat_redirect";t.URI;wx.ready(function(){wx.onMenuShareAppMessage({desc:"抓小鸡，赢红包！",link:l,success:function(){},cancel:function(){}}),wx.onMenuShareTimeline({link:l,success:function(){},cancel:function(){}})})}e.warning=!1}else e.warning=!0;e.validate(),e.setup(),e.getHistory(),e.emit()})},setup:function(){var t=this;t.getData(),t.buttons.go.on("click",function(n){var s=e(this);t.verify?t.checkStatus(function(n){var o=n.code,c=n.status;"-1"==o&&"success"!=c?(e("#notify-msg").html(n.message),a.hash="#modal-notify"):(i.setAttribute("preload","auto"),i.play(),s.replaceWith('<a href="javascript:;" class="btn-start">开始游戏</a>'),t.elements.tray.css({"z-index":0,visibility:"hidden"}),r.initialize())}):t.validate(),n.preventDefault()})},emit:function(){e("#go-history").on("click",function(e){a.hash="#modal-history",e.preventDefault()})},validate:function(){var t=this,n=t.config,i=t.subscribe,s=t.binded,o=t.warning,r=t.started,c=t.overend,l=e("#notify-msg");if(!r)return t.verify=!1,l.html("活动还未开始哦~"),void(a.hash="#modal-notify");if(c)return t.verify=!1,l.html("您来晚了，活动已经结束咯~"),void(a.hash="#modal-notify");if(o)return a.hash="#modal-warn",void(t.verify=!1);if(!i)return l.html("不好意思，请您先关注我们的公众号!"),a.hash="#modal-notify",void(t.verify=!1);if(!s){var d="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+n.APPID+"&redirect_uri="+n.URI+"wechat-web/tokens/getWechatOpenId?callback_redirect="+a.href+"&response_type=code&scope=snsapi_base&state=#state##wechat_redirect";return e("#go-bind").attr("href",d),a.hash="#modal-subscribe",void(t.verify=!1)}return t.verify=!0,t.verify},getData:function(){var t=this,n=t._API,i=t.params,s={openId:i.openId,token:i.token};e.ajax({url:n+"chicken/initInfo",type:"POST",data:JSON.stringify(s),dataType:"json",contentType:"application/json; charset=UTF-8",timeout:3e3}).then(function(e){"success"==e.status&&t.setState(e)}).fail(function(){a.hash="#modal-warn"})},getHistory:function(){var t=this,n=t._API,i=t.params,s={openId:i.openId,token:i.token};e.ajax({url:n+"chicken/listChicken",type:"POST",data:JSON.stringify(s),dataType:"json",contentType:"application/json; charset=UTF-8",timeout:3e3}).then(function(e){t.setPrizes(e)}).fail(function(){a.hash="#modal-warn"})},getUserInfo:function(t){var n,i=this,s=i.config,o=i.parameter.code||sessionStorage.getItem("code");o||(a.hash="#modal-warn");var r=encodeURIComponent(a.href)||"";e.ajax({url:s.URI+s.API+"authen/user/info",data:{code:o||"",signurl:r},timeout:5e3}).then(function(e){n=e}).fail(function(){a.hash="#modal-warn"}).done(function(){t&&t.call(null,n)})},checkStatus:function(t){var n=this,i=n._API,s=n.params,o={openId:s.openId,token:s.token};e.ajax({url:i+"chicken/checkIsChicken",type:"POST",data:JSON.stringify(o),dataType:"json",contentType:"application/json; charset=UTF-8",timeout:3e3}).then(function(e){t&&t.call(null,e)}).fail(function(){a.hash="#modal-warn"})},setState:function(t){var n=this,i=(n.verify,t.data),s=Date.now(),o=+new Date(i.beginTime+" 00:00:00"),r=+new Date(i.endTime+" 23:59:59"),c=e("#notify-msg");e("#lottery-date").html(i.beginTime+"-"+i.endTime),e("#lottery-count").html(i.count),o>=s&&(n.started=!1,c.html("活动还未开始哦~"),a.hash="#modal-notify"),r<s&&(n.overend=!0,c.html("您来晚了，活动已经结束咯~"),a.hash="#modal-notify")},setPrizes:function(t){var n=this,i=t.status,s=t.data,o=e("#prize");if("success"==i&&s.length>0){for(var r=s.length,c=0,l="";c<r;c++){var d=s[c].createTime,u=parseFloat(s[c].money),h=c+1,m=new Date(d),f=m.getFullYear()+"-"+(m.getMonth()+1)+"-"+m.getDate();l+=u>0?'<div class="history-row"><div class="cell">'+h+'</div><div class="cell">&yen;'+u+'</div><div class="cell">'+f+'</div><div class="cell"><a href="javascript:;" data-money="'+u+'">领取</a></div></div>':'<div class="history-row"><div class="cell">'+h+'</div><div class="cell">&yen;'+u+'</div><div class="cell">'+f+'</div><div class="cell">领取</div></div>'}o.html(l)}o.on("click","a",function(t){var a=e(this),i=parseFloat(a.attr("data-money"));n.toRedPack(i),t.preventDefault()}),e("#go-pickup").on("click",function(t){var i=(e(this),n.parameter.amount);i>0?n.toRedPack(i):(e("#notify-msg").html("领取红包的金额不能为0~"),a.hash="#modal-notify"),t.preventDefault()})},toRedPack:function(t,n){var i=this,s=i._API,o=i.params,r={openId:o.openId,token:o.token,money:t};e.ajax({url:s+"chicken/receiveHongBao",type:"POST",data:JSON.stringify(r),dataType:"json",contentType:"application/json; charset=UTF-8",timeout:3e3}).then(function(i){"success"==i.status?(e(".modal-amount").html(t),a.hash="#modal-success",n&&n.call(null,i)):(e("#notify-msg").html(i.message),a.hash="#modal-notify")}).fail(function(){a.hash="#modal-warn"})},saveData:function(t){var n=this,i=n._API,s=n.params,o={openId:s.openId,token:s.token,money:t};e.ajax({url:i+"chicken/addInfo",type:"POST",data:JSON.stringify(o),dataType:"json",contentType:"application/json; charset=UTF-8",timeout:3e3}).then(function(n){if("success"==n.status){var i="timeover.html?amount="+t;a.href=i}else{var s=n.message;e("#notify-msg").html(s),e("#modal-notify").find(".btn-confirm").on("click",function(e){a.reload(),e.preventDefault()}),a.hash="#modal-notify"}}).fail(function(){e("#modal-warn").find(".btn-confirm").on("click",function(e){a.reload(),e.preventDefault()}),a.hash="#modal-warn"})}},r={animals:null,holes:null,items:[],once:!1,started:!0,count:0,amount:0,elements:{canvas:e("#zodiac-stage")},native:{stage:null,canvas:null,container:null},holeManifest:[{src:"hole.png",id:"ground"},{src:"hole-mask.png",id:"hole"}],manifest:[{src:"animal-mouse.png",id:"mouse"},{src:"animal-cattle.png",id:"cattle"},{src:"animal-tiger.png",id:"tiger"},{src:"animal-rabbit.png",id:"rabbit"},{src:"animal-dragon.png",id:"dragon"},{src:"animal-snake.png",id:"snake"},{src:"animal-horse.png",id:"horse"},{src:"animal-sheep.png",id:"sheep"},{src:"animal-monkey.png",id:"monkey"},{src:"animal-chicken.png",id:"chicken"},{src:"animal-dog.png",id:"dog"},{src:"animal-pig.png",id:"pig"}],holeCoord:[131,291,451,611],coordinates:[{x:54,y:102},{x:288,y:102},{x:522,y:102},{x:54,y:262},{x:288,y:262},{x:522,y:262},{x:54,y:422},{x:288,y:422},{x:522,y:422},{x:54,y:582},{x:288,y:582},{x:522,y:582}],matrices:[.6,.01,.05,.2,.02,.3,.08,1,.02,.06],settings:{cw:Math.min(document.documentElement.clientWidth||document.body.clientWidth,720),dw:750,dh:742,sr:1,hw:174,hh:58,ow:0,oh:0},initialize:function(){var e=this,t=e.settings;e.settings.sr=t.cw/t.dw,e.settings.ow=t.cw,e.settings.oh=t.dh*t.sr,e.elements.canvas.attr("width",t.ow).attr("height",t.oh),e.native.canvas=e.elements.canvas[0],e.native.stage=new createjs.Stage(e.native.canvas),createjs.Touch.enable(e.native.stage),e.native.stage.enableMouseOver(10),e.native.stage.mouseMoveOutside=!0,e.holes=new createjs.LoadQueue(!1),e.holes.addEventListener("complete",e.holeComplete),e.holes.loadManifest(e.holeManifest,!0,"../images/")},setup:function(){},countdown:function(){var t=this,n=20,a=null,s=e("#countdown-count"),r=function(){var e=parseFloat(t.amount).toFixed(2);if(n--,s.html(n+"s"),1==n)return clearTimeout(n),a=null,t.stop(),i.pause(),void o.saveData(e);a=setTimeout(function(){r()},1e3)};setTimeout(function(){r()},1e3)},holeComplete:function(){var t,n=r,a=n.holes,i=n.settings,s=n.native.stage,o=n.coordinates,c=n.holeCoord,l=n.matrices,d=l.length,u=i.sr,h=(i.ht,0),m=e("#real-amount");n.started&&(n.countdown(),n.started=!1),n.once=!1;var f=new createjs.Bitmap(a.getResult("ground"));f.setTransform(0,0,u,u),t=new createjs.Container,n.native.container=t,n.getAnimals(function(s){var r=s.getItems()||[];n.items=r;for(var f=(i.hw,i.hh,r),p=f.length,g=0;g<p;g++){var v=f[g].result,y=f[g].item,w=o[g],k=(v.width,v.height),I=new createjs.Bitmap(v),b=w.x*u,T=(w.y+i.hh)*u;if(v.id=y.id,I.setTransform(b,T,u,u),t.addChild(I),(g+1)%3==0){var j=new createjs.Bitmap(a.getResult("hole")),x=c[h]*u;j.setTransform(0,x,u,u),h++,t.addChild(j)}var A=(k-i.hh/2)*u,P=T-A,S=!1;createjs.Tween.get(I,{loop:!0}).to({y:P},800).to({y:T},800).call(function(){S||n.holeComplete(),S=!0})}createjs.Ticker.timingMode=createjs.Ticker.RAF,createjs.Ticker.addEventListener("tick",n.tick),e(t).one("click",function(e){if("chicken"==e.target.image.id){var t=n.count,a=(d+t%d)%d,i=l[a];n.amount+=i,m.html(parseFloat(n.amount).toFixed(2)+"元"),n.count++,n.setAmountAnimation(i)}})}),new createjs.Bitmap(a.getResult("hole")).setTransform(0,0,u,u),s.addChild(f,t),s.update()},getAnimals:function(e){var t=this;t.manifest=s.shuffle(t.manifest),t.animals=new createjs.LoadQueue(!1),t.animals.addEventListener("complete",function(){e&&e.call(null,t.animals)}),t.animals.loadManifest(t.manifest,!0,"../images/")},setAmountAnimation:function(e){for(var t,n=r,a=n.animals,i=n.settings,s=n.coordinates,o=n.native.stage,c=a.getItems()||[],l=i.sr,d=i.hw,u=i.hh,h=0,m=c.length;h<m;h++){"chicken"==c[h].item.id&&(t=s[h])}var f=new createjs.Text("+"+e,"60px","#f7ab33"),p=(t.x+d/2)*l,g=(t.y-u)*l;f.set({x:p,y:g}),f.textAlign="center";createjs.Tween.get(f).to({scaleX:2,scaleY:2},300).to({alpha:0,y:g-40},500,createjs.Ease.getPowInOut(2));o.addChild(f)},setBounds:function(){for(var e=this,t=e.settings,n=e.native.stage,a=e.native.container,i=(t.sr,e.coordinates,s.shuffle(e.items)),o=i.length,r=0;r<o;r++){var c=i[r].result,l=new createjs.Bitmap(c);a.addChild(l),n.update()}},tick:function(){r.native.stage.update()},stop:function(){var t=r;createjs.Tween.removeAllTweens(),createjs.Ticker.removeEventListener("tick",t.tick),e(t.native.container).off("click")}},c={params:null,initialize:function(){this.params=s.query(a.search)||{},this.setup()},setup:function(){this.filling()},filling:function(){var t=this,n=t.params.amount;e("#over-round").html(n)}};t.Lottery=o,t.Gameout=c}(jQuery,window||this);